<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Definición de la codificación de caracteres como UTF-8 para soportar caracteres especiales -->
    <meta charset="UTF-8">
    
    <!-- Establece la escala del sitio para dispositivos móviles, haciendo que sea responsivo -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Título de la página, que se muestra en la pestaña del navegador -->
    <title>Gestión de Stock</title>
    
    <!-- Enlace a los archivos de estilo CSS para la página -->
    <link rel="stylesheet" href="../public/css/style.css">
    <link rel="stylesheet" href="../public/css/stok.css">
</head>
<body onload="listProducts()">
    <!-- Cabecera principal del sitio -->
    <header class="main-header">
        <nav>
            <ul class="navigation">
                <li><a href="index.html">Home</a></li>
                <li><a href="stok.html">Stock</a></li>
                <li><a href="facturacion.html">Facturación</a></li>
                <li><a href="perfil.html">Perfil</a></li>
                <li><a href="edit.html">Editar Perfil</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <!-- Formulario para agregar un nuevo producto -->
        <form id="product-form">
            <input type="text" id="product-name" name="productname" placeholder="Nombre del producto" required>
            <input type="text" id="product-mark" placeholder="Marca del producto" required>
            <input type="number" id="product-quantity" placeholder="Cantidad" required>
            <input type="number" id="product-price" placeholder="Precio Unitario" required>
            <!-- Botón para agregar un nuevo producto -->
            <button type="submit" id="submit-btn" name="submit">Agregar Producto</button>
            <!-- Botón para guardar los cambios al editar un producto -->
            <button type="button" id="save-btn" style="display:none;" onclick="saveProduct()">Guardar Cambios</button>
        </form>
        
        <!-- Tabla para listar los productos -->
        <table id="product-table">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Marca</th>
                    <th>Cantidad</th>
                    <th>Precio Unitario</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <!-- Los productos se agregarán aquí -->
            </tbody>
        </table>
    </main>

    <!-- Pie de página -->
    <footer>
        <p>&copy; 2024 Gestión de Stock</p>
    </footer>

    <!-- Scripts para gestionar los productos -->
    <script>
        let currentProductId = null;  // Variable global para almacenar el ID del producto a editar

        // Función para listar productos
        function listProducts() {
            fetch('http://localhost:3000/api/products')
                .then(response => response.json())  // Procesar la respuesta como JSON
                .then(products => {
                    const tableBody = document.querySelector('#product-table tbody');
                    tableBody.innerHTML = '';  // Limpiar la tabla antes de agregar los nuevos productos

                    products.forEach((product) => {
                        const row = document.createElement('tr');

                        // Si el producto está agotado, aplicamos la clase 'producto-agotado' para destacarlo
                        if (product.quantity === 0) {
                            row.classList.add('producto-agotado');
                        }

                        // Agregar una nueva fila a la tabla con la información del producto
                        row.innerHTML = `
                            <td>${product.name}</td>
                            <td>${product.mark}</td>
                            <td>${product.quantity}</td>
                            <td>${product.price}</td>
                            <td>
                                <button class="edit" onclick="editProduct(${product.id})">Editar</button>
                                <button class="outofstock" onclick="outOfStock(${product.id})">Agotar producto</button>
                                ${product.quantity === 0 ? `<button class="reactivate" onclick="reactivateProduct(${product.id})">Reactivar producto</button>` : ''}
                            </td>
                        `;
                        tableBody.appendChild(row);  // Añadir la fila a la tabla
                    });
                })
                .catch(error => console.error('Error al listar productos:', error));  // Manejo de errores
        }

        // Función para agregar un producto
        document.getElementById('product-form').addEventListener('submit', function(event) {
            event.preventDefault();  // Evitar que la página se recargue al enviar el formulario

            if (currentProductId === null) {  // Si no estamos en modo editar
                const name = document.getElementById('product-name').value;
                const mark = document.getElementById('product-mark').value;
                const quantity = document.getElementById('product-quantity').value;
                const price = document.getElementById('product-price').value;

                const newProduct = { name, mark, quantity, price };

                fetch('http://localhost:3000/api/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newProduct)  // Enviar los datos del nuevo producto al servidor
                })
                .then(response => response.json())  // Procesar la respuesta como JSON
                .then(data => {
                    alert('Producto agregado exitosamente');
                    listProducts();  // Recargar la lista de productos
                    resetForm();  // Limpiar el formulario
                })
                .catch(error => console.error('Error al agregar producto:', error));  // Manejo de errores
            }
        });

        // Función para editar un producto
        function editProduct(id) {
            fetch(`http://localhost:3000/api/products/${id}`)
                .then(response => response.json())  // Obtener los detalles del producto a editar
                .then(product => {
                    document.getElementById('product-name').value = product.name;
                    document.getElementById('product-mark').value = product.mark;
                    document.getElementById('product-quantity').value = product.quantity;
                    document.getElementById('product-price').value = product.price;

                    currentProductId = id;  // Guardar el ID del producto que se está editando

                    // Mostrar el botón "Guardar Cambios" y ocultar el botón de "Agregar Producto"
                    document.getElementById('submit-btn').style.display = 'none';
                    document.getElementById('save-btn').style.display = 'inline-block';
                })
                .catch(error => console.error('Error al obtener el producto:', error));  // Manejo de errores
        }

        // Función para guardar los cambios de un producto
        function saveProduct() {
            const updatedProduct = {
                name: document.getElementById('product-name').value,
                mark: document.getElementById('product-mark').value,
                quantity: document.getElementById('product-quantity').value,
                price: document.getElementById('product-price').value
            };

            fetch(`http://localhost:3000/api/products/${currentProductId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedProduct)  // Enviar los datos actualizados al servidor
            })
            .then(response => response.json())  // Procesar la respuesta como JSON
            .then(data => {
                alert('Producto actualizado');
                listProducts();  // Recargar la lista
                resetForm();  // Limpiar el formulario y restablecer el estado
            })
            .catch(error => console.error('Error al actualizar el producto:', error));  // Manejo de errores
        }

        // Función para reiniciar el formulario
        function resetForm() {
            document.getElementById('product-name').value = '';
            document.getElementById('product-mark').value = '';
            document.getElementById('product-quantity').value = '';
            document.getElementById('product-price').value = '';
            document.getElementById('submit-btn').style.display = 'inline-block';  // Mostrar el botón de agregar
            document.getElementById('save-btn').style.display = 'none';  // Ocultar el botón de guardar
            currentProductId = null;  // Limpiar el ID del producto actual
        }

        // Función para agotar un producto
        function outOfStock(id) {
            fetch(`http://localhost:3000/api/products/outofstock/${id}`, {
                method: 'PUT'
            })
            .then(response => response.json())  // Procesar la respuesta como JSON
            .then(data => {
                alert('Producto agotado');
                listProducts();  // Recargar la lista
            })
            .catch(error => console.error('Error al agotar el producto:', error));  // Manejo de errores
        }

        // Función para reactivar un producto
        function reactivateProduct(id) {
            fetch(`http://localhost:3000/api/products/reactivate/${id}`, {
                method: 'PUT'
            })
            .then(response => response.json())  // Procesar la respuesta como JSON
            .then(data => {
                alert('Producto reactivado');
                listProducts();  // Recargar la lista
            })
            .catch(error => console.error('Error al reactivar el producto:', error));  // Manejo de errores
        }
    </script>
</body>
</html>
